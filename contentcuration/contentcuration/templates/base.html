<!DOCTYPE HTML>
{% load cache %}
{% load staticfiles %}
{% load i18n %}
{% load raven %}
{% load render_bundle from webpack_loader %}
{% load render_bundle_css from translation_tags %}
{% load render_offline_css from translation_tags %}
{% get_current_language as LANGUAGE_CODE %}
{% get_current_language_bidi as LANGUAGE_BIDI %}

<html dir="{{ LANGUAGE_BIDI|yesno:'rtl,ltr' }}" lang="{{ LANGUAGE_CODE }}">
    <head>
        {% block head %}
        <script>
            window.DEBUG = "{{DEBUG}}" === "True";
            window.languageCode = "{{LANGUAGE_CODE}}";
            window.isRTL = "{{ LANGUAGE_BIDI }}" === "True";
            try{
              window.ALL_MESSAGES = JSON.parse("{{ messages|escapejs}}");
            } catch (error) { /* Page does not require front-end translations */ }
        </script>
        {% cache 60 head_cache %}
        <!--[if lt IE 9]>
            <script src="{% static "js/html5shiv.js" %}"></script>
        <![endif] -->
        <!-- make sure configuring Sentry is one of the very first things we do in order to catch the most errors. -->

        <!-- for some reason, load raven commmand doesn't actually load the raven JS library, so do so here
             TODO: Should we install and bundle this as a dep using yarn?
        -->
        <script src="https://cdn.ravenjs.com/3.26.4/raven.min.js" crossorigin="anonymous"></script>
        <script>
            // Ignore errors when CloudFlare-AlwaysOnline is in the user agent as these are errors serving
            // the offline version and I don't think we can fix or reproduce these easily.
            // Fix taken from here: https://github.com/getsentry/sentry-javascript/issues/617#issuecomment-227562203
            Raven.config('{% sentry_public_dsn %}', {
                  shouldSendCallback: function(data) {
                    return !/^(.*CloudFlare-AlwaysOnline.*)$/.test(window.navigator.userAgent);
                  },
                  // If there are errors that are known bugs in third-party libs or are clearly harmless,
                  // add them here to reduce sentry noise.
                  ignoreErrors: [
                    // These appear to be errors in Summernote, but we have yet to reproduce. Although we get a lot
                    // of Sentry reports with these errors, they lack a stack trace, and we also have not yet gotten
                    // any user reports of this problem. For the moment, silence them so that they don't drown out
                    // other errors. We may wish to remove these once we resolve the other errors.
                    'IndexSizeError: Failed to execute \'setStart\' on \'Range\'',
                    'IndexSizeError: Failed to execute \'setEnd\' on \'Range\'',
                    'IndexSizeError: Index or size is negative or greater than the allowed amount',
                  ]
                }).install()
        </script>
        <link rel="shortcut icon" href="{% static 'img/logo.ico' %}">

        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        {% render_bundle_css 'common' %}

        {% if not debug %}
            <script src={% static 'django_js_reverse/js/reverse.js' %}></script>
        {% else %}
            <script src="{% url 'js_reverse' %}" type="text/javascript"></script>
        {% endif %}

        {% render_bundle 'common' 'js' %}

        <!-- fullstory integration, only on develop until we add an opt-in option. -->
        {% if request.get_host == 'develop.studio.learningequality.org' %}
        <script>
            window['_fs_debug'] = false;
            window['_fs_host'] = 'fullstory.com';
            window['_fs_org'] = 'FCSD3';
            window['_fs_namespace'] = 'FS';
            (function(m,n,e,t,l,o,g,y){
              // eslint-disable-next-line no-console
                if (e in m) {if(m.console && m.console.log) { m.console.log('FullStory namespace conflict. Please set window["_fs_namespace"].');} return;}
                g=m[e]=function(a,b){g.q?g.q.push([a,b]):g._api(a,b);};g.q=[];
                o=n.createElement(t);o.async=1;o.src='https://'+_fs_host+'/s/fs.js';
                y=n.getElementsByTagName(t)[0];y.parentNode.insertBefore(o,y);
                g.identify=function(i,v){g(l,{uid:i});if(v)g(l,v)};g.setUserVars=function(v){g(l,v)};g.event=function(i,v,s){g('event',{n:i,p:v,s:s})};
                g.shutdown=function(){g("rec",!1)};g.restart=function(){g("rec",!0)};
                g.consent=function(a){g("consent",!arguments.length||a)};
                g.identifyAccount=function(i,v){o='account';v=v||{};v.acctId=i;g(o,v)};
                g.clearUserCookie=function(){};
            })(window,document,window['_fs_namespace'],'script','user');
        </script>
        {% endif %}
        {% endcache %}
        {% block css_bundle %}
            {% render_bundle_css 'base' %}
        {% endblock css_bundle %}
        {% render_offline_css LANGUAGE_CODE %}
        <title>Kolibri Studio ({% trans 'Beta' %})</title>
      {% endblock head %}

      {% block analytics_data_layer %}
        <script>
          // Google tag manager data layer https://developers.google.com/tag-manager/devguide
          dataLayer = [{
            studioVersion: 'v1',
            currentUser: JSON.parse("{{ current_user|escapejs }}"),
          }];
        </script>
      {% endblock analytics_data_layer %}

      {% block analytics %}
        <script>
          // Backwards compatible
          function gtag(){dataLayer.push(arguments);}
        </script>
        <!-- Google Tag Manager -->
        <script>
          (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
          new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
          j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
          'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
          })(window,document,'script','dataLayer','GTM-M6TP6S5');
        </script>
        <!-- End Google Tag Manager -->
      {% endblock %}
      {% block style %}{% endblock style %}
  </head>
  <body data-app>
      {% block nav %}
      <!-- Navigation bar -->
      <nav>
        <div id="top-navigation">
          <div id="main-nav-left">
            <a href="/channels" id="logo-container">
              <img class="navbar-brand" src="{% static 'img/logo.png' %}">
              <label id="kolibri_label"><span dir="ltr">Kolibri Studio</span> <span dir="auto">{% trans '(Beta)' %}</span></label>
            </a>
          </div>
          <div id="main-nav-right">
            <div id="username_label">{% blocktrans with name=user.first_name %}Hello, {{name}}{% endblocktrans %}</div>
            <div class="btn-group">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                <span class="material-icons">account_circle</span>
              </a>
              <ul class="dropdown-menu dropdown-menu-right">
                <li id="username_label_collapsed">{% blocktrans with name=user.first_name %}Hello, {{name}}{% endblocktrans %}</li>
                {% if user.is_admin %}<li><a href="{% url 'administration' %}" >{% trans "Administration" %}</a></li>{% endif %}
                <li><a href="{% url 'profile_settings' %}" >{% trans "Settings" %}</a></li>
                <li><a href="http://kolibri-studio.readthedocs.io/en/latest/index.html" target="_blank">{% trans "Help" %}</a></li>
                <li><a href="{% url 'logout' %}">{% trans "Log Out" %}</a></li>
              </ul>
            </div>
          </div>
        </div>

    </nav>

    {% if INCIDENT %}
      <div id="emergency-banner" class="text-center main-banner {% if INCIDENT.readonly %}error-banner{% else %}warning-banner{% endif %}">
        <i class="material-icons">error</i> {{INCIDENT.message | safe}}
      </div>
    {% elif DEPRECATED %}
      <div class="text-center main-banner warning-banner" id="redirect-banner">
        <i class="material-icons">error</i> {% blocktrans %}Contentworkshop.learningequality.org has been deprecated. Please go to <a href="https://studio.learningequality.org">studio.learningequality.org</a> for the latest version of Studio{% endblocktrans %}
      </div>
    {% elif BETA_MODE %}

      <div id="beta-banner" class="text-center warning-banner main-banner">
        <i class="material-icons">card_giftcard</i> {% url 'updates' as update_url %}{% blocktrans %}<a href="{{update_url}}" target="_blank">Kolibri Studio is getting a makeover,</a> and we're finally ready to show it to you! We will be upgrading the server, starting on January 13th at 9AM PST. During the upgrade process, the server will be down or in read-only mode. We estimate this process could take up to 48 hours to complete, so we strongly recommend you avoid trying to work on the server until January 15th at 9AM PST. Thank you for your patience and understanding, and we hope you enjoy the new Studio!"{% endblocktrans %}
      </div>
    {% endif %}
    {% endblock nav %}

    <!-- Site content gets injected here -->
    {% block content %}{% endblock content %}
    <!-- prevent more than 1 bundle per page -->
      {% block js_bundle %}
        {% cache 60 base_bundle_cache %}
        {% render_bundle 'base' 'js' %}
        {% endcache %}
      {% endblock js_bundle %}
    </body>
</html>
